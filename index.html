<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediCalc-Vet – Profile (v5.2)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --sep:rgba(255,255,255,.10); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans'; background:linear-gradient(180deg,#0b1023,#0f172a 35%); color:var(--ink); }
    .wrap { max-width: 1100px; margin: 18px auto; padding: 0 12px; }
    header { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .header-left { display:flex; flex-direction:column; gap:2px; }
    h1 { font-size: clamp(18px, 2.2vw, 26px); margin:0; font-weight:700; letter-spacing:.2px; white-space:nowrap; }
    .sub { color:var(--muted); font-size: 12px; line-height:1.2; }
    .actions .btn { margin-left:6px; }
    .card { background: rgba(17,24,39,.88); border:1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 10px; box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:8px; }
    label { font-size: 11px; color: var(--muted); display:block; margin-bottom:3px; }
    input[type="number"], input[type="text"], select {
      width:100%; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.12);
      background:#0b1222; color:var(--ink); outline:none; font-size: 13px;
    }
    input::placeholder { color:#6b7280; }
    .btn { border:1px solid rgba(255,255,255,.14); background:#0b1222; color:var(--ink);
      padding:5px 9px; border-radius:8px; cursor:pointer; transition:.15s; display:inline-flex; gap:6px; align-items:center; font-size:13px; }
    .btn:hover { transform: translateY(-1px); border-color: rgba(255,255,255,.28); }
    .btn.accent { background:#0e2b17; border-color:#1b5e2d; }
    .btn.danger { background:#2a1212; border-color:#5e1b1b; }
    .btn.ghost { background: transparent; border-color:rgba(255,255,255,.20); }
    .btn.equal { min-width: 110px; justify-content:center; }
    .btn.icon { padding: 2px 6px; font-size:12px; }
    .rowbar { display:flex; gap:6px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin:6px 0; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    thead th { text-align:left; font-size:11px; color:var(--muted); font-weight:600; padding:5px 6px; border-bottom:1px solid var(--sep); }
    tbody td { padding:5px 6px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align: middle; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    .right { text-align: right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color: var(--muted); }
    .totals { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:6px; font-size:13px; }
    .hint { font-size:11px; color:var(--muted); }
    input[type=file] { display:none; }
    @media (max-width: 720px) { .grid { grid-template-columns: repeat(6, 1fr); } }
  

/* Logo Styling */
.logo-wrap { display:flex; align-items:center; justify-content:center; padding:0 12px; }
.logo-wrap img { height: 60px; width:auto; display:block; }
@media (max-width: 640px) { .logo-wrap img { height: 45px; } }
 }





.footer-mk { 
  margin-top: 20px;
  width: 100%;
  text-align: right; 
  font-size: 16px; 
  font-weight: bold; 
  font-family: Arial, sans-serif; 
  color: goldenrod; 
  text-shadow: 1px 1px 2px #000, 0 0 5px gold, 0 0 10px orange; 
}





/* Letzte Spalte in allen Tabellen hervorheben */
table tbody td:last-child,
table thead th:last-child,
table tfoot td:last-child {
  font-size: 15px;
  font-weight: bold;
}

</style>

<style>
.btn-toggle {
    font-size: 26px !important;
    padding: 0 6px !important;
    cursor: pointer;
}
</style>


<style>
#printButton {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}
#printButton:hover {
    background-color: #45a049;
}
</style>


<style>
#btn-print {
  background-color: #4CAF50 !important;
  color: white !important;
  border: none !important;
  font-size: 17px !important;
  padding: 8px 16px !important;
  border-radius: 6px !important;
  cursor: pointer !important;
}
#btn-print:hover {
  background-color: #45a049 !important;
}
</style>


<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f14">
<link rel="apple-touch-icon" href="icons/icon-180.png">


<style>
/* helper (unused by default): hide-dose class for table #tbl-1 if needed */
#tbl-1.hide-dose thead th:nth-child(2),
#tbl-1.hide-dose tbody td:nth-child(2) { display:none; }
</style>


<style>
/* Exakte Ausrichtung der Summenzeile */
table tfoot td { border-top: 1px solid rgba(255,255,255,.08); }
table tfoot td .sumcell { display:block; text-align:right; padding-right:8px; }
table tfoot td.right { padding-right:0; } /* padding handled by .sumcell */
</style>

<style>
/* Korrektur: 'Volumen ml' ist die zweitletzte Spalte (letzte ist Löschen) */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  font-size: 15px !important;
  font-weight: 700 !important;
}
</style>
<style>
/* Gelbliche Hervorhebung der Spalte 'Volumen ml' */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  background-color: rgba(255, 255, 150, 0.15) !important;
}

/* Summenzeile 'Gesamt-ml' größer und fett */
table tfoot td:nth-last-child(2) {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: #fff8dc !important; /* leicht heller Gelbton für bessere Lesbarkeit */
}
</style>
<style>
/* Volumen-ml-Spalte: schwarzer Hintergrund, weiße Schrift */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  background-color: #000 !important;
  color: #ffffff !important;
  font-size: 15px !important;
  font-weight: 700 !important;
}

/* Summenzeile 'Gesamt-ml' noch etwas größer und weiß */
table tfoot td:nth-last-child(2) {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: #ffffff !important;
}
</style>
<style>
/* Volumen-ml-Spalte: dunkles Blau, weiße Schrift */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  background-color: #0a1a33 !important; /* dunkles Blau passend zum Layout */
  color: #ffffff !important;
  font-size: 15px !important;
  font-weight: 700 !important;
}

/* Summenzeile 'Gesamt-ml' größer, fett, weiß */
table tfoot td:nth-last-child(2) {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: #ffffff !important;
}
</style>
<style>
/* Volumen-ml-Spalte: gleiche Farbe wie Eingabefelder (#0b1222), weiße Schrift */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  background-color: #0b1222 !important;
  color: #ffffff !important;
  font-size: 15px !important;
  font-weight: 700 !important;
}

/* Summenzeile 'Gesamt-ml' größer, fett, weiß */
table tfoot td:nth-last-child(2) {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: #ffffff !important;
}
</style>
<style>
/* Volumen-ml-Spalte: gleiche Farbe wie Eingabefelder (#0b1222), weiße Schrift, dezenter Rahmen */
table tbody td:nth-last-child(2),
table thead th:nth-last-child(2),
table tfoot td:nth-last-child(2) {
  background-color: #0b1222 !important;
  color: #ffffff !important;
  font-size: 15px !important;
  font-weight: 700 !important;
  border-left: 2px solid rgba(255,255,255,0.15) !important;
  border-right: 2px solid rgba(255,255,255,0.15) !important;
}

/* Summenzeile 'Gesamt-ml' größer, fett, weiß */
table tfoot td:nth-last-child(2) {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: #ffffff !important;
}
</style>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="mc-icon.png">

<style>
/* --- Version Popup Modal (one-time) --- */
#version-modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: none; align-items: center; justify-content: center; z-index: 9999;
}
#version-modal {
  width: min(560px, 92vw);
  background: #0b1222; color: #e5e7eb;
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,.45);
  overflow: hidden;
}
#version-modal header {
  display:flex; align-items:center; justify-content:space-between;
  padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.08);
}
#version-modal header h3 { margin:0; font-size: 18px; }
#version-modal .modal-body { padding: 14px; font-size: 14px; line-height: 1.5; }
#version-modal .modal-body ul { margin: 8px 0 0 18px; }
#version-modal .modal-actions {
  display:flex; gap:10px; justify-content:flex-end; padding: 12px 14px;
  border-top: 1px solid rgba(255,255,255,.08);
}
#version-modal .btn-close {
  appearance: none; border: 1px solid rgba(255,255,255,.2);
  background: #0b1222; color: #e5e7eb; padding: 6px 10px;
  border-radius: 8px; cursor: pointer; font-size: 13px;
}
#version-modal .btn-x {
  appearance: none; border: none; background: transparent; color: #9ca3af;
  font-size: 18px; cursor: pointer; padding: 4px 8px; border-radius: 6px;
}
#version-modal .btn-x:hover { background: rgba(255,255,255,.06); color: #e5e7eb; }
</style>

</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-left">
        <h1>MediCalc-Vet <span style="font-size:12px; font-weight:normal; color:#9ca3af; margin-left:8px;">v2.0</span></h1>
        <div class="sub">Getrennte Profile (Hund, Katze, …), lokale Speicherung, Export/Import.</div>
      </div>
      
<div class="logo-wrap" title="Praxis-Logo">
  <div id="logo-slot" tabindex="0" role="button" aria-label="Logo hochladen" style="width:189px;height:45px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px dashed rgba(255,255,255,.25);border-radius:6px;background:transparent;">
    <input type="file" id="logo-input" accept="image/*" aria-label="Logo-Datei auswählen" style="display:none;">
    <div id="logo-placeholder" style="display:flex;gap:6px;align-items:center;font-size:12px;color:#9ca3af;pointer-events:none;">
      <!-- tiny inline upload icon -->
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 16V4m0 0l4 4m-4-4L8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 16v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>Upload&nbsp;Logo</span>
    </div>
    <img id="logo-img" alt="Logo" style="width:100%;height:100%;display:none;object-fit:contain;">
  </div>
</div>
<div class="actions">
        <button class="btn ghost" id="btn-print" title="Drucken / PDF erstellen">🖨️ Drucken</button>
      </div>
    </header>

    <!-- Stammdaten + Speicher-Toolbar (kompakt) -->
    <div class="card" style="margin-bottom:8px;">
      <div class="grid">
        <div class="col" style="grid-column: span 3;">
          <label for="species">Tierart (Profile verwalten)</label>
          <div class="rowbar" style="margin:0; justify-content:flex-start;">
            <select id="species" style="flex:1 1 auto; min-width: 0;"></select>
            <div style="display:flex; gap:6px;">
              <button class="btn" id="btn-add-species" title="Neue Tierart hinzufügen">＋</button>
              <button class="btn danger" id="btn-remove-species" title="Aktuelle Tierart löschen">–</button>
            </div>
          </div>
        </div>
        <div class="col" style="grid-column: span 3;">
          <label for="weight">Körpergewicht (kg)</label>
          <input id="weight" type="number" step="0.01" min="0" placeholder="z. B. 12,5" />
        </div>
        <div class="col" style="grid-column: span 6;">
          <label>Speichern & Verwaltung</label>
          <div class="rowbar" style="margin:0;">
            <button class="btn" id="btn-save" title="Manuell speichern">💾 Speichern</button>
            <button class="btn" id="btn-reset-species" title="Nur diese Tierart zurücksetzen">🔄 Tierart</button>
            <button class="btn danger" id="btn-reset-all" title="Alle Tierarten & Daten löschen">🗑️ Alles</button>
            <button class="btn equal" id="btn-export" title="Alle Daten als JSON sichern">⬇️ Export</button>
            <button class="btn equal" id="btn-import" title="JSON importieren">⬆️ Import</button>
            <input id="file-import" type="file" accept="application/json" />
          </div>
          <div class="hint">Autosave ist aktiv: Jede Änderung wird sofort gespeichert.</div>
        </div>
      </div>
    </div>

    <!-- Abschnitt 1: Anästhesie / Hauptmedikamente -->
    <div class="card" style="margin-bottom:8px;">
      <div class="rowbar">
        <strong>Anästhesie / Hauptmedikamente (i.v)</strong>
        <div class="rowbar">
          <select id="rounding-1" class="btn" title="Rundung">
            <option value="none" selected>Rundung: aus</option>
            <option value="0.01">Rundung: 0,01 ml</option>
            <option value="0.05">Rundung: 0,05 ml</option>
            <option value="0.1">Rundung: 0,1 ml</option>
            <option value="0.5">Rundung: 0,5 ml</option>
          </select>
          <button class="btn accent" id="btn-add-1" title="Zeile hinzufügen">＋ Zeile</button>
         <button class="btn" id="btn-toggle-1" class="btn btn-toggle" title="Ein-/Ausblenden" style="font-size: 26px; padding: 0 6px;">▾</button></div>
      </div>

      <div id="sec-body-1"><table id="tbl-1">
        <thead>
          <tr>
            <th style="width:40%;">Wirkstoff / Präparat</th>
            <th style="width:13%;">Dosis<br><span class="muted small">mg/kg</span></th>
            <th style="width:15%;">Konz.<br><span class="muted small">mg/ml</span></th>
            <th class="right" style="width:16%;">Menge<br><span class="muted small">mg</span></th>
            <th class="right" style="width:12%;">Volumen<br><span class="muted small">ml</span></th>
            <th style="width:4%;"></th>
          </tr>
        </thead>
        <tbody id="rows-1"></tbody>
      
<tfoot>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑mg:</span> <span class="num mono" id="sumMg-1">0</span></div></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑ml:</span> <span class="num mono" id="sumMl-1">0</span></div></td>
    <td></td>
  </tr>
</tfoot>
      </table>

    </div>
<!-- Abschnitt 2: Narkose intramuskulär (i.m.) -->
    <div class="card" style="margin-bottom:8px;">
      <div class="rowbar">
        <strong>Anästhesie / Hauptmedikamente (i.m.)</strong>
        <div class="rowbar">
          <select id="rounding-2" class="btn" title="Rundung">
            <option value="none" selected>Rundung: aus</option>
            <option value="0.01">Rundung: 0,01 ml</option>
            <option value="0.05">Rundung: 0,05 ml</option>
            <option value="0.1">Rundung: 0,1 ml</option>
            <option value="0.5">Rundung: 0,5 ml</option>
          </select>
          <button class="btn accent" id="btn-add-2" title="Zeile hinzufügen">＋ Zeile</button>
         <button class="btn" id="btn-toggle-2" class="btn btn-toggle" title="Ein-/Ausblenden" style="font-size: 26px; padding: 0 6px;">▾</button></div>
      </div>

      <div id="sec-body-2"><table id="tbl-2">
        <thead>
          <tr>
            <th style="width:40%;">Wirkstoff / Präparat</th>
            <th style="width:13%;">Dosis<br><span class="muted small">mg/kg</span></th>
            <th style="width:15%;">Konz.<br><span class="muted small">mg/ml</span></th>
            <th class="right" style="width:16%;">Menge<br><span class="muted small">mg</span></th>
            <th class="right" style="width:12%;">Volumen<br><span class="muted small">ml</span></th>
            <th style="width:4%;"></th>
          </tr>
        </thead>
        <tbody id="rows-2"></tbody>
      
<tfoot>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑mg:</span> <span class="num mono" id="sumMg-2">0</span></div></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑ml:</span> <span class="num mono" id="sumMl-2">0</span></div></td>
    <td></td>
  </tr>
</tfoot>
      </table>

    </div>

    <!-- Abschnitt 3: Aufwach-Medikamente / Antagonisten -->
    <div class="card">
      <div class="rowbar">
        <strong>Aufwach‑Medikamente (Antagonisten)</strong>
        <div class="rowbar">
          <select id="rounding-3" class="btn" title="Rundung">
            <option value="none" selected>Rundung: aus</option>
            <option value="0.01">Rundung: 0,01 ml</option>
            <option value="0.05">Rundung: 0,05 ml</option>
            <option value="0.1">Rundung: 0,1 ml</option>
            <option value="0.5">Rundung: 0,5 ml</option>
          </select>
          <button class="btn accent" id="btn-add-3" title="Zeile hinzufügen">＋ Zeile</button>
         <button class="btn" id="btn-toggle-3" class="btn btn-toggle" title="Ein-/Ausblenden" style="font-size: 26px; padding: 0 6px;">▾</button></div>
      </div>

      <div id="sec-body-3"><table id="tbl-3">
        <thead>
          <tr>
            <th style="width:40%;">Wirkstoff / Präparat</th>
            <th style="width:13%;">Dosis<br><span class="muted small">mg/kg</span></th>
            <th style="width:15%;">Konz.<br><span class="muted small">mg/ml</span></th>
            <th class="right" style="width:16%;">Menge<br><span class="muted small">mg</span></th>
            <th class="right" style="width:12%;">Volumen<br><span class="muted small">ml</span></th>
            <th style="width:4%;"></th>
          </tr>
        </thead>
        <tbody id="rows-3"></tbody>
      
<tfoot>
  <tr>
    <td></td>
    <td></td>
    <td></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑mg:</span> <span class="num mono" id="sumMg-3">0</span></div></td>
    <td class="right"><div class="sumcell"><span class="muted">Gesamt‑ml:</span> <span class="num mono" id="sumMl-3">0</span></div></td>
    <td></td>
  </tr>
</tfoot>
      </table>
    </div>

    
  </div>

  <template id="row-template">
    <tr>
      <td><input type="text" placeholder="z. B. Medikament" class="inp-name" /></td>
      <td><input type="text" inputmode="decimal" placeholder="0,2" class="inp-dose mono" /></td>
      <td><input type="text" inputmode="decimal" placeholder="10" class="inp-conc mono" /></td>
      <td class="right mono out-mg">0</td>
      <td class="right mono out-ml">0</td>
      <td class="right"><button class="btn icon danger btn-del" title="Zeile entfernen">✕</button></td>
    </tr>
  </template>

  <script>
    (function() {
      const STORAGE_KEY = 'vetDoseCalc_v5_2';
      const MAX_ROWS = 10;

      // Elements
      const speciesEl = document.getElementById('species');
      const btnAddSpecies = document.getElementById('btn-add-species');
      const btnRemoveSpecies = document.getElementById('btn-remove-species');
      const weightEl = document.getElementById('weight');
      const rounding1 = document.getElementById('rounding-1');
      const rounding2 = document.getElementById('rounding-2');
      const rounding3 = document.getElementById('rounding-3');
      const rows1 = document.getElementById('rows-1');
      const rows2 = document.getElementById('rows-2');
      const rows3 = document.getElementById('rows-3');
      const sumMg1 = document.getElementById('sumMg-1');
      const sumMl1 = document.getElementById('sumMl-1');
      const sumMg2 = document.getElementById('sumMg-2');
      const sumMg3 = document.getElementById('sumMg-3');
      const sumMl2 = document.getElementById('sumMl-2');
      const sumMl3 = document.getElementById('sumMl-3');
      const btnAdd1 = document.getElementById('btn-add-1');
      const btnAdd2 = document.getElementById('btn-add-2');
      const btnAdd3 = document.getElementById('btn-add-3');
      const btnToggle1 = document.getElementById('btn-toggle-1');
      const btnToggle2 = document.getElementById('btn-toggle-2');
      const btnToggle3 = document.getElementById('btn-toggle-3');
      const secBody1 = document.getElementById('sec-body-1');
      const secBody2 = document.getElementById('sec-body-2');
      const secBody3 = document.getElementById('sec-body-3');
      const btnPrint = document.getElementById('btn-print');
      const btnSave = document.getElementById('btn-save');
      const btnResetSpecies = document.getElementById('btn-reset-species');
      const btnResetAll = document.getElementById('btn-reset-all');
      const btnExport = document.getElementById('btn-export');
      const btnImport = document.getElementById('btn-import');
      const fileImport = document.getElementById('file-import');
      const tpl = document.getElementById('row-template');

      // Helpers
      function parseNum(v){ if(typeof v!=='string') return Number(v)||0; v=v.replace(/\s/g,'').replace(',', '.'); const n=Number(v); return isFinite(n)?n:0; }
      function formatNum(n,d=2){ return (isFinite(n)?n:0).toLocaleString('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}); }
      function getStep(sel){ const v=sel.value; if(v==='none') return 0; const n=parseNum(v); return isFinite(n)?n:0; }
      function defaultSpeciesData(){ return { weight:'', section1:{rounding:'none',rows:[]}, section2:{rounding:'none',rows:[]}, section3:{rounding:'none',rows:[]} }; }
      function defaultSpeciesList(){ return ['Hund','Katze','Pferd','Rind','Schwein','Kleintier / anderes']; }

      function readStore(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||{} }catch(e){ return {} } }
      function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
      function ensureStore(){
        const s = readStore();
        if(!s.speciesData) s.speciesData = {};
        if(!s.speciesList || !Array.isArray(s.speciesList) || s.speciesList.length===0) s.speciesList = defaultSpeciesList();
        if(!s.currentSpecies || !s.speciesList.includes(s.currentSpecies)) s.currentSpecies = s.speciesList[0];
        s.speciesList.forEach(k=>{ if(!s.speciesData[k]) s.speciesData[k]=defaultSpeciesData(); });
        return s;
      }

      function renderSpeciesOptions(list, current){
        speciesEl.innerHTML = '';
        list.forEach(name=>{
          const opt=document.createElement('option');
          opt.value = name; opt.textContent = name;
          if(name===current) opt.selected = true;
          speciesEl.appendChild(opt);
        });
      }

      function loadSpecies(key){
        const store = ensureStore();
        const data = store.speciesData[key] || defaultSpeciesData();
        weightEl.value = data.weight || '';
        rounding1.value = data.section1.rounding || '0.05';
        rounding2.value = data.section2.rounding || '0.05';
        rounding3.value = (data.section3 && data.section3.rounding) || '0.05';
        rows1.innerHTML=''; rows2.innerHTML=''; rows3.innerHTML='';
        (data.section1.rows||[]).slice(0,MAX_ROWS).forEach(r=>addRow(rows1,r));
        (data.section2.rows||[]).slice(0,MAX_ROWS).forEach(r=>addRow(rows2,r));
        (data.section3?.rows||[]).slice(0,MAX_ROWS).forEach(r=>addRow(rows3,r));
        if(rows1.children.length===0) for(let i=0;i<3;i++) addRow(rows1);
        if(rows2.children.length===0) for(let i=0;i<2;i++) addRow(rows2);
        calc();
      }

      function saveSpecies(key){
        const store = ensureStore();
        store.speciesData[key] = {
          weight: weightEl.value,
          section1: { rounding: rounding1.value,
            rows: Array.from(rows1.querySelectorAll('tr')).map(tr=>({
              name: tr.querySelector('.inp-name').value,
              dose: tr.querySelector('.inp-dose').value,
              conc: tr.querySelector('.inp-conc').value
            })) },
          section2: { rounding: rounding2.value,
            rows: Array.from(rows2.querySelectorAll('tr')).map(tr=>({
              name: tr.querySelector('.inp-name').value,
              dose: tr.querySelector('.inp-dose').value,
              conc: tr.querySelector('.inp-conc').value
            })) },
          section3: { rounding: rounding3.value,
            rows: Array.from(rows3.querySelectorAll('tr')).map(tr=>({
              name: tr.querySelector('.inp-name').value,
              dose: tr.querySelector('.inp-dose').value,
              conc: tr.querySelector('.inp-conc').value
            })) }
        };
        store.currentSpecies = key;
        writeStore(store);
      }

      
      // === Cepedex Sonderregel (Hund, i.v.) ===
      // Fachgrundlage: 375 µg/m² i.v. bei Hunden; BSA = 0.101 * kg^(2/3); Ampulle 0,5 mg/ml -> ml = 0.75 * BSA
      const DOG_IV_UG_PER_M2 = 375;
      function dogBSA(kg){ return 0.101 * Math.pow(Math.max(kg,0), 2/3); }

      // Deine feste Tabelle bis 10 kg (i.v., 0,5 mg/ml); Interpolation für Zwischenwerte
      const CEP_TABLE = { 1:0.08, 2:0.12, 3:0.16, 4:0.19, 5:0.22, 6:0.25, 7:0.28, 8:0.30, 9:0.33, 10:0.35 };

      function isCepedexRow(tr){
        const n=(tr.querySelector('.inp-name')?.value||'').toLowerCase();
        return n.includes('cepedex'); // tolerant: 'cepedex', 'cepedex 0,5' etc.
      }
      function getCepedexMlFromTable(kg){
        if(!kg || kg<=0) return 0;
        const keys = Object.keys(CEP_TABLE).map(Number).sort((a,b)=>a-b);
        if (CEP_TABLE[kg]!=null) return CEP_TABLE[kg];
        // Interpolation / Extrapolation
        let lo=keys[0], hi=keys[keys.length-1];
        for (let i=0;i<keys.length;i++){
          if (keys[i] <= kg) lo = keys[i];
          if (keys[i] >= kg){ hi = keys[i]; break; }
        }
        if (kg <= keys[0]){
          const k1=keys[0], k2=keys[1]??keys[0];
          const m = (CEP_TABLE[k2]-CEP_TABLE[k1]) / Math.max(1,(k2-k1));
          return CEP_TABLE[k1] + m*(kg-k1);
        }
        if (kg >= keys[keys.length-1]){
          const k1=keys[keys.length-2]??keys[keys.length-1], k2=keys[keys.length-1];
          const m = (CEP_TABLE[k2]-CEP_TABLE[k1]) / Math.max(1,(k2-k1));
          return CEP_TABLE[k2] + m*(kg-k2);
        }
        const m = (CEP_TABLE[hi]-CEP_TABLE[lo]) / Math.max(1,(hi-lo));
        return CEP_TABLE[lo] + m*(kg-lo);
      }

      function calcTable(rootRows,sumMgEl,sumMlEl,stepSel){
        const kg=parseNum(weightEl.value); let sMg=0,sMl=0; const step=getStep(stepSel);
        rootRows.querySelectorAll('tr').forEach(tr=>{
          const dose=parseNum(tr.querySelector('.inp-dose').value);
          const conc=parseNum(tr.querySelector('.inp-conc').value);
          let mg = kg*dose; let ml = conc>0 ? mg/conc : 0;
          const isIV = (rootRows === rows1);
          const species = (speciesEl && speciesEl.value) ? speciesEl.value.trim() : '';
          if (isIV && species === 'Hund' && isCepedexRow(tr)){
            // 1–10 kg: Tabelle (inkl. Interpolation), >10 kg: BSA-Formel (ml = 0.75 * BSA)
            if (kg <= 10) {
              ml = getCepedexMlFromTable(kg);
            } else {
              ml = 0.75 * dogBSA(kg);
            }
            // mg aus ml * (mg/ml); wenn leer/0 -> 0.5 mg/ml annehmen (Anzeige bleibt unberührt)
            let concField = tr.querySelector('.inp-conc');
            let concVal = parseNum(concField?.value || '');
            if (!(concVal > 0)) concVal = 0.5;
            mg = ml * concVal;
          }
if(step && step>0) ml=Math.round(ml/step)*step;
          tr.querySelector('.out-mg').textContent = formatNum(mg);
          tr.querySelector('.out-ml').textContent = formatNum(ml, step>=0.1?1:2);
          sMg+=mg; sMl+=ml;
        });
        sumMgEl.textContent = formatNum(sMg);
        sumMlEl.textContent = formatNum(sMl, step>=0.1?1:2);
      }
      function toggleSec(el, btn, key){
        const show = (el.style.display==='none');
        el.style.display = show ? '' : 'none';
        btn.textContent = show ? '▾' : '▸';
        const s = ensureStore(); s.ui = s.ui||{}; s.ui.collapsed = s.ui.collapsed||{};
        s.ui.collapsed[key] = (el.style.display==='none');
        writeStore(s);
      }
      function applyCollapsedFromStore(){
        const s = ensureStore(); const c=(s.ui&&s.ui.collapsed)||{};
        [[secBody1,btnToggle1,1],[secBody2,btnToggle2,2],[secBody3,btnToggle3,3]].forEach(([el,btn,k])=>{
          const col = !!c[k]; el.style.display = col ? 'none' : ''; btn.textContent = col ? '▸' : '▾';
        });
      }
      function calc(){ calcTable(rows1,sumMg1,sumMl1,rounding1); calcTable(rows2,sumMg2,sumMl2,rounding2); calcTable(rows3,sumMg3,sumMl3,rounding3); }

      function addRow(rootRows, pref={}){
        if(rootRows.children.length>=MAX_ROWS){ alert('Maximal 10 Zeilen in dieser Tabelle.'); return; }
        const node = tpl.content.firstElementChild.cloneNode(true);
        rootRows.appendChild(node);
        node.querySelector('.inp-name').value = pref.name || '';
        node.querySelector('.inp-dose').value = pref.dose ?? '';
        node.querySelector('.inp-conc').value = pref.conc ?? '';
        node.querySelectorAll('input').forEach(inp=>inp.addEventListener('input',()=>{ calc(); saveSpecies(speciesEl.value); }));
        node.querySelector('.btn-del').addEventListener('click',()=>{ node.remove(); calc(); saveSpecies(speciesEl.value); });
      }

      // Species management
      btnAddSpecies.addEventListener('click', ()=>{
        const name = prompt('Name der neuen Tierart (z. B. Frettchen):');
        if(!name) return;
        const store = ensureStore();
        if(store.speciesList.includes(name)){ alert('Diese Tierart existiert bereits.'); return; }
        store.speciesList.push(name);
        store.speciesData[name] = defaultSpeciesData();
        store.currentSpecies = name;
        writeStore(store);
        renderSpeciesOptions(store.speciesList, name);
        loadSpecies(name);
      });

      btnRemoveSpecies.addEventListener('click', ()=>{
        const store = ensureStore();
        if(store.speciesList.length<=1){ alert('Mindestens eine Tierart muss bestehen bleiben.'); return; }
        const key = speciesEl.value;
        if(!confirm(`Tierart „${key}“ wirklich löschen?`)) return;
        delete store.speciesData[key];
        store.speciesList = store.speciesList.filter(x=>x!==key);
        store.currentSpecies = store.speciesList[0];
        writeStore(store);
        renderSpeciesOptions(store.speciesList, store.currentSpecies);
        loadSpecies(store.currentSpecies);
      });

      // Core events (Autosave überall)
      speciesEl.addEventListener('change', (e)=>{
        const prevStore = ensureStore();
        saveSpecies(prevStore.currentSpecies || speciesEl.value);
        const next = e.target.value;
        const s = ensureStore(); s.currentSpecies = next; writeStore(s);
        loadSpecies(next);
      });
      [weightEl, rounding1, rounding2].forEach(el=>el.addEventListener('input',()=>{ calc(); saveSpecies(speciesEl.value); }));
      btnAdd1.addEventListener('click', ()=>{ addRow(rows1); saveSpecies(speciesEl.value); });
      btnAdd2.addEventListener('click', ()=>{ addRow(rows2); saveSpecies(speciesEl.value); });
      btnAdd3.addEventListener('click', ()=>{ addRow(rows3); saveSpecies(speciesEl.value); });
      btnToggle1.addEventListener('click', ()=>{ toggleSec(secBody1, btnToggle1, 1); });
      btnToggle2.addEventListener('click', ()=>{ toggleSec(secBody2, btnToggle2, 2); });
      btnToggle3.addEventListener('click', ()=>{ toggleSec(secBody3, btnToggle3, 3); });
      btnPrint.addEventListener('click', ()=>window.print());
      btnSave.addEventListener('click', ()=>{ saveSpecies(speciesEl.value); alert('Gespeichert.'); });
      btnResetSpecies.addEventListener('click', ()=>{
        if(!confirm('Nur diese Tierart auf Werkzustand zurücksetzen?')) return;
        const store = ensureStore();
        store.speciesData[speciesEl.value] = defaultSpeciesData();
        writeStore(store); loadSpecies(speciesEl.value);
      });
      btnResetAll.addEventListener('click', ()=>{
        if(!confirm('WIRKLICH alle Tierarten und Daten löschen?')) return;
        localStorage.removeItem(STORAGE_KEY);
        const s = ensureStore();
        renderSpeciesOptions(s.speciesList, s.currentSpecies);
        loadSpecies(s.currentSpecies);
        applyCollapsedFromStore();
      });

      // Export/Import
      btnExport.addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(readStore(), null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='vetDoseCalc_backup.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
      });
      btnImport.addEventListener('click', ()=> fileImport.click());
      fileImport.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const obj = JSON.parse(ev.target.result);
            writeStore(obj);
            const s = ensureStore();
            renderSpeciesOptions(s.speciesList, s.currentSpecies);
            loadSpecies(s.currentSpecies);
        applyCollapsedFromStore();
          } catch { alert('Import fehlgeschlagen: ungültige Datei.'); }
        };
        reader.readAsText(f);
        e.target.value = '';
      });

      // Init
      (function init(){
        const s = ensureStore();
        renderSpeciesOptions(s.speciesList, s.currentSpecies);
        loadSpecies(s.currentSpecies);
        applyCollapsedFromStore();
      })();
    })();
  </script>

<div class="footer-mk"></div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>




<script>
(function(){
  // Debounce for smooth typing
  var timer = null;
  function debounce(fn){ if (timer) clearTimeout(timer); timer = setTimeout(fn, 120); }

  function isHund(){
    var sp = document.querySelector('#species');
    if(!sp) return false;
    var t = sp.options && sp.selectedIndex >= 0 ? (sp.options[sp.selectedIndex].text || '') : sp.value || '';
    t = (t||'').toLowerCase();
    return t.indexOf('hund') !== -1;
  }

  function getDoseColIndex(){
    var ths = document.querySelectorAll('#tbl-1 thead th');
    for (var i=0;i<ths.length;i++){
      var txt = (ths[i].textContent||'').toLowerCase();
      if (txt.indexOf('dosis') !== -1) return i;
    }
    return 1; // fallback
  }

  function rowHasCepedex(tr){
    if (!tr || !tr.cells || !tr.cells.length) return false;
    var cell = tr.cells[0];
    var v = '';
    var inp = cell.querySelector('input, textarea, select');
    if (inp){
      if (inp.tagName === 'SELECT'){
        var idx = inp.selectedIndex;
        if (idx >= 0 && inp.options && inp.options[idx]){
          v = (inp.options[idx].text || '').toLowerCase();
        } else {
          v = (inp.value || '').toLowerCase();
        }
      } else {
        v = (inp.value || '').toLowerCase();
      }
    } else {
      v = (cell.textContent || '').toLowerCase();
    }
    return v.indexOf('cepedex') !== -1;
  }

  function applyPerRow(){
    var tbl = document.getElementById('tbl-1');
    if (!tbl) return;
    var idx = getDoseColIndex();
    // Header bleibt sichtbar; wir steuern NUR die Zellen je Zeile, ohne Layout zu verschieben
    var body = tbl.tBodies && tbl.tBodies.length ? tbl.tBodies[0] : null;
    if (!body) return;
    var hund = isHund();
    for (var r=0; r<body.rows.length; r++){
      var tr = body.rows[r];
      var td = tr.cells && tr.cells[idx];
      if (!td) continue;
      var hide = hund && rowHasCepedex(tr);
      // Layout beibehalten: table-cell bleibt erhalten, Inhalt unsichtbar & nicht fokussierbar
      if (hide){
        td.style.display = '';               // wichtig: nicht 'none'
        td.style.opacity = '0';              // unsichtbar
        td.style.pointerEvents = 'none';     // keine Interaktion
        td.setAttribute('aria-hidden','true');
        // Eingabefelder deaktivieren, damit Tab-Reihenfolge sauber ist
        var inputs = td.querySelectorAll('input, select, textarea, button');
        inputs.forEach(function(el){ el.setAttribute('disabled','disabled'); el.setAttribute('tabindex','-1'); });
      } else {
        td.style.opacity = '';
        td.style.pointerEvents = '';
        td.removeAttribute('aria-hidden');
        var inputs = td.querySelectorAll('input[disabled], select[disabled], textarea[disabled], button[disabled]');
        inputs.forEach(function(el){ el.removeAttribute('disabled'); el.removeAttribute('tabindex'); });
      }
    }
  }

  function schedule(){ debounce(applyPerRow); }

  window.addEventListener('DOMContentLoaded', function(){
    var sp = document.querySelector('#species');
    if (sp){ sp.addEventListener('input', schedule); sp.addEventListener('change', schedule); }
    var tbl = document.getElementById('tbl-1');
    if (tbl){
      tbl.addEventListener('input', schedule, true);
      tbl.addEventListener('change', schedule, true);
      tbl.addEventListener('click', schedule, true);
    }
    applyPerRow();
  });
})();
</script>




<footer style="
  margin-top: 30px;
  padding: 12px 20px;
  background-color: #111827;
  border-top: 1px solid rgba(255,255,255,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: #9ca3af;">
  <span>Designed by MK</span>
  <a href="https://www.paypal.com/donate/?hosted_button_id=3SBSGUFTBBCKG" target="_blank" style="text-decoration:none;">
    <button style="
      background-color:#15803d;
      border:none;
      color:white;
      padding:8px 18px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition: background 0.2s ease;">
      Spenden
    </button>
  </a>
</footer>


<!-- One-time Version Notes Modal -->
<div id="version-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="version-modal-title">
  <div id="version-modal">
    <header>
      <h3 id="version-modal-title">Neuerungen – Version&nbsp;2.0</h3>
      <button class="btn-x" id="version-modal-x" aria-label="Popup schließen">✕</button>
    </header>
    <div class="modal-body">
      <p>Dieses Fenster erscheint nur beim ersten Start nach einem Update.</p>
      <ul>
        <li>Versionsnummer geändert</li>
        <li>Logo-Upload hinzugefügt: Jede Praxis kann jetzt ihr eigenes Logo einfügen</li>
      </ul>
    </div>
    <div class="modal-actions">
      <button class="btn-close" id="version-modal-close">OK</button>
    </div>
  </div>
</div>

<script>
(function() {
  const CURRENT_VERSION = '2.0';
  const KEY = 'mediCalcVet_seen_version_' + CURRENT_VERSION;

  function showModal() {
    const backdrop = document.getElementById('version-modal-backdrop');
    if (!backdrop) return;
    backdrop.style.display = 'flex';
  }
  function hideModal() {
    const backdrop = document.getElementById('version-modal-backdrop');
    if (!backdrop) return;
    backdrop.style.display = 'none';
  }

  function markSeen() {
    try { localStorage.setItem(KEY, '1'); } catch (e) {}
  }

  function wire() {
    const b1 = document.getElementById('version-modal-close');
    const b2 = document.getElementById('version-modal-x');
    if (b1) b1.addEventListener('click', () => { markSeen(); hideModal(); });
    if (b2) b2.addEventListener('click', () => { markSeen(); hideModal(); });
  }

  // Only show once per version on this device/browser
  let seen = null;
  try { seen = localStorage.getItem(KEY); } catch (e) {}

  if (!seen) {
    // Defer until DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => { wire(); showModal(); }, { once: true });
    } else {
      wire(); showModal();
    }
  } else {
    // ensure listeners still exist (no show)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', wire, { once: true });
    } else {
      wire();
    }
  }
})();
</script>








<script>
document.addEventListener('DOMContentLoaded', function() {
  var slot = document.getElementById('logo-slot');
  var input = document.getElementById('logo-input');
  var img = document.getElementById('logo-img');
  var ph = document.getElementById('logo-placeholder');
  var KEY = 'mediCalcVet_logo_dataurl_v1';

  if (!slot || !input || !img || !ph) return;

  // Restore persisted logo if available
  try {
    var saved = localStorage.getItem(KEY);
    if (saved) {
      img.src = saved;
      img.style.display = 'block';
      ph.style.display = 'none';
    }
  } catch (e) {}

  function openPicker() {
    try { input.click(); } catch (e) {}
  }
  slot.addEventListener('click', openPicker);
  slot.addEventListener('keydown', function(ev) {
    if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openPicker(); }
  });

  input.addEventListener('change', function(ev) {
    var file = ev.target.files && ev.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      var dataUrl = e.target.result;
      img.src = dataUrl;
      img.style.display = 'block';
      ph.style.display = 'none';
      // Persist to localStorage so it survives reloads (F5)
      try { localStorage.setItem(KEY, dataUrl); } catch (e) {}
    };
    reader.readAsDataURL(file);
  });
});
</script>

</body>
</html>
